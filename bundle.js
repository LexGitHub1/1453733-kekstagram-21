(()=>{"use strict";(()=>{const e=function(e,t,n){e.responseType="json",e.addEventListener("load",(function(){200===e.status?t(e.response):n("Статус ответа: "+e.status+" "+e.statusText)})),e.addEventListener("error",(function(){n("Произошла ошибка соединения")})),e.addEventListener("timeout",(function(){n("Запрос не успел выполниться за "+e.timeout+"мс")})),e.timeout=1e4};window.server={load:function(t,n){const o=new XMLHttpRequest;o.open("GET","https://21.javascript.pages.academy/kekstagram/data"),e(o,t,n),o.send()},upload:function(t,n,o){const c=new XMLHttpRequest;c.open("POST","https://21.javascript.pages.academy/kekstagram/"),e(c,n,o),c.send(t)}}})(),window.timeOut={debounce:function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}}},(()=>{const e=document.querySelector(".big-picture"),t=e.querySelector(".social"),n=t.querySelector(".social__comments"),o=t.querySelector(".social__comment-count"),c=n.querySelector("li"),r=t.querySelector(".comments-loader"),i=e.querySelector(".big-picture__cancel");let s=[];o.classList.add("hidden");const d=function(e){const t=e.splice(0,5),o=document.createDocumentFragment();t.forEach((function(e){const t=function(e){const{avatar:t,name:n,message:o}=e,r=c.cloneNode(!0),i=r.querySelector(".social__picture"),s=r.querySelector(".social__text");return i.src=t,i.alt=n,i.width=35,i.height=25,s.textContent=o,r}(e);o.append(t)})),n.append(o)},l=function(){d(s),0===s.length&&(r.classList.add("hidden"),r.removeEventListener("click",l))},a=function(e){"Escape"===e.key&&(e.preventDefault(),m())},u=function(e){e.preventDefault(),m()},m=function(){e.classList.add("hidden"),document.removeEventListener("keydown",a),document.body.classList.remove("modal-open"),i.removeEventListener("click",u)};window.bigImgShow={openBigPicture:function(t){const{url:o,likes:c,comments:m,description:f}=t;s=m.slice(),n.innerHTML="",e.querySelector(".big-picture__img img").src=o,e.querySelector(".likes-count").textContent=c,e.querySelector(".comments-count").textContent=m.length,e.querySelector(".social__caption").textContent=f,d(s),e.classList.remove("hidden"),document.body.classList.add("modal-open"),document.addEventListener("keydown",a),i.addEventListener("click",u),m.length>5?(r.classList.remove("hidden"),r.addEventListener("click",l)):r.classList.add("hidden")},bigPictureEscPressHandler:a,bigPicture:e}})(),(()=>{const e=document.querySelector(".pictures"),t=document.querySelector(".img-filters"),n=window.bigImgShow.openBigPicture,o=document.querySelector("#picture").content.querySelector(".picture"),c=function(t){const n=document.createDocumentFragment();return t.forEach((function(e){n.appendChild(function(e){const{likes:t,comments:n,url:c}=e,r=o.cloneNode(!0);return r.querySelector(".picture__likes").textContent=t,r.querySelector(".picture__comments").textContent=n.length,r.querySelector("img").src=c,r}(e))})),e.appendChild(n),n},r=function(e){document.querySelectorAll(".picture").forEach((function(t,o){t.addEventListener("click",(function(t){t.preventDefault(),n(e[o])}))}))};window.server.load((function(e){window.cardCreate.cardsList=[],window.cardCreate.cardsList=e,c(e),r(e),t.classList.remove("img-filters--inactive")}),(function(e){const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})),window.cardCreate={renderPictures:c,clickSmallPhoto:r}})(),(()=>{const e=document.querySelector(".img-filters__form"),t=window.cardCreate.renderPictures,n=function(){const e=window.cardCreate.cardsList;t(e),window.cardCreate.clickSmallPhoto(e)},o=window.timeOut.debounce((function(o){switch(document.querySelectorAll(".picture").forEach((function(e){e.remove()})),function(t){const n=e.querySelector(".img-filters__button--active"),{target:o}=t;o.classList.contains("img-filters__button--active")||(n.classList.remove("img-filters__button--active"),o.classList.add("img-filters__button--active"))}(o),o.target.id){case"filter-default":n();break;case"filter-random":!function(){const e=function(e){const t=window.cardCreate.cardsList.slice(),n=10<t.length?10:t.length-1;for(let e=0;e<n;e++){const n=Math.floor(Math.random()*(t.length-e))+e,o=t[e];t[e]=t[n],t[n]=o}return t}().slice(0,10);t(e),window.cardCreate.clickSmallPhoto(e)}();break;case"filter-discussed":!function(){const e=window.cardCreate.cardsList.slice().sort((function(e,t){return t.comments.length-e.comments.length}));t(e),window.cardCreate.clickSmallPhoto(e)}();break;default:n()}}));e.addEventListener("click",o)})(),(()=>{const e=/^#([а-яА-Я]|[a-zA-Z]|[0-9]){1,20}$/,t="Нельзя указать больше пяти хэш-тегов",n="Один и тот же хэш-тег не может быть использован дважды",o="Не верный формат хештега",c=document.querySelector(".text__hashtags"),r=document.querySelector(".text__description");c.addEventListener("input",(function(){const r=c.value.replace(/ +/g," ").trim().toLowerCase().split(" "),i=r.length<=5,s=r.every((function(t){return e.test(t)})),d=r.every((function(e,t,n){return n.indexOf(e)===t}));c.setCustomValidity(""),i||c.setCustomValidity(t),s||c.setCustomValidity(o),d||c.setCustomValidity(n),c.reportValidity(),""===c.value&&c.setCustomValidity(""),s&&d&&i||""===c.value?(c.style.outline="",c.style.background=""):(c.style.outline="2px solid red",c.style.background="pink")})),c.addEventListener("focusin",(function(){document.removeEventListener("keydown",window.modalOpenClose.onPhotoEditEscPress)})),c.addEventListener("focusout",(function(){document.addEventListener("keydown",window.modalOpenClose.onPhotoEditEscPress)})),r.oninput=function(){const e=r.value.length;r.value.length>120?r.setCustomValidity("Удалите "+(120-e)+" симв."):r.setCustomValidity(""),r.reportValidity()},r.addEventListener("focusin",(function(){document.removeEventListener("keydown",window.modalOpenClose.onPhotoEditEscPress)})),r.addEventListener("focusout",(function(){document.addEventListener("keydown",window.modalOpenClose.onPhotoEditEscPress)}))})(),(()=>{const e=document.querySelector(".img-upload__form"),t=document.querySelector(".img-upload__overlay"),n=function(){window.effects.setDefaultDepth(),window.modalOpenClose.uploadFile.value="",window.scale.photoPrew.style.filter="",window.scale.photoPrew.style.transform="scale(1.00)",window.scale.photoPrew.className="effects__preview--none",window.effects.effectLevel.classList.add("hidden")};e.addEventListener("submit",(function(o){window.server.upload(new FormData(e),(function(){e.reset(),n(),t.classList.add("hidden"),window.success.successUploadHandler()}),(function(){window.error.errorUploadHandler()})),o.preventDefault()})),window.submit={resetImageData:n}})(),(()=>{const e=document.querySelector(".img-upload__overlay"),t=document.querySelector(".img-upload__preview img"),n=document.querySelector(".img-upload__effect-level"),o=document.querySelector("#upload-file"),c=document.querySelector(".img-upload__cancel"),r=function(t){"Escape"===t.key&&(t.preventDefault(),e.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"))};c.addEventListener("click",(function(){t.className="",t.style.transform="",e.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),document.removeEventListener("keydown",r),n.classList.add("hidden")})),o.addEventListener("change",(function(){if(e.classList.remove("hidden"),n.classList.add("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",r),o.files&&o.files[0]){const e=new FileReader;e.onload=function(e){t.setAttribute("src",e.target.result)},e.readAsDataURL(o.files[0])}})),window.modalOpenClose={onPhotoEditEscPress:r,uploadFile:o,photoEdit:e}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),n=t.querySelector(".success__inner"),o=t.querySelector(".success__button"),c=function(){o.removeEventListener("click",r),document.removeEventListener("click",i),document.removeEventListener("keydown",s),e.removeChild(t)},r=function(){c()},i=function(e){e.target!==n&&c()},s=function(e){"Escape"===e.key&&c()};window.success={successUploadHandler:function(){e.insertAdjacentElement("afterbegin",t),o.addEventListener("click",r),document.addEventListener("click",i),document.addEventListener("keydown",s)}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),n=t.querySelector(".error__button"),o=t.querySelector(".error__inner"),c=function(){e.removeChild(t),n.removeEventListener("click",r),document.removeEventListener("click",i),document.removeEventListener("keydown",s)},r=function(){c()},i=function(e){e.target!==o&&c()},s=function(e){"Escape"===e.key&&c()};window.error={errorUploadHandler:function(){e.insertAdjacentElement("beforeend",t),n.addEventListener("click",r),document.addEventListener("click",i),document.addEventListener("keydown",s)}}})(),(()=>{const e=document.querySelector(".img-upload__effect-level"),t=document.querySelector(".effects"),n=document.querySelector(".effect-level"),o=e.querySelector(".effect-level__depth"),c=e.querySelector(".effect-level__pin"),r=e.querySelector(".effect-level__value"),i=document.querySelector(".effects__item:first-child"),s=document.querySelectorAll(".effects__item"),d=[1,2];t.addEventListener("click",(function(e){e.target.matches('input[type="radio"]')&&(window.scale.photoPrew.className="",l(),window.scale.photoPrew.className="effects__preview--"+e.target.value)}));const l=function(){c.style.left="100%",o.style.width="100%",r.value=100,window.scale.photoPrew.style.filter=""},a=function(e){const t=e/100;if(window.scale.photoPrew.className.match("effects__preview--"))switch(window.scale.photoPrew.className){case"effects__preview--chrome":window.scale.photoPrew.style.filter=`grayscale(${1*t})`;break;case"effects__preview--sepia":window.scale.photoPrew.style.filter=`sepia(${1*t})`;break;case"effects__preview--marvin":window.scale.photoPrew.style.filter=`invert(${e}%)`;break;case"effects__preview--phobos":window.scale.photoPrew.style.filter=`blur(${3*t}px)`;break;case"effects__preview--heat":window.scale.photoPrew.style.filter=`brightness(${d[1]*t+d[0]})`;break;default:window.scale.photoPrew.style.filter=""}};c.addEventListener("mousedown",(function(t){const n=e.querySelector(".effect-level__line").offsetWidth;let i=t.clientX;const s=function(e){const t=i-e.clientX;i=e.clientX;let s=c.offsetLeft-t;s<0?s=0:s>n&&(s=n),c.style.left=s+"px",o.style.width=s+"px",r.value=Math.round(100*s/n),a(r.value)},d=function(){document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",s),document.addEventListener("mouseup",d)})),s.forEach((function(t){t.addEventListener("click",(function(){e.classList.remove("hidden")}))})),i.addEventListener("click",(function(){e.classList.add("hidden")}));const u={initSlider:function(e){c.addEventListener("mousedown",(function(t){"function"==typeof e&&a(t)}))}};window.effects={setDefaultDepth:l,effectLevel:n,slider:u}})(),(()=>{const e=document.querySelector(".img-upload__preview img"),t=document.querySelector(".scale__control--smaller"),n=document.querySelector(".scale__control--bigger"),o=document.querySelector(".scale__control--value");let c=100;t.addEventListener("click",(function(t){t.preventDefault(),c>25&&(c-=25,o.value=c+"%",e.style.transform=`scale(${c/100})`)})),n.addEventListener("click",(function(t){t.preventDefault(),c<100&&(c+=25,o.value=c+"%",e.style.transform=`scale(${c/100})`)})),window.scale={photoPrew:e}})()})();